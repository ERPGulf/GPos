[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "promotion",
  "enabled": 1,
  "modified": "2025-08-25 15:35:30.861759",
  "module": "Gpos",
  "name": "promotion uom",
  "script": "frappe.ui.form.on(\"promotion\", {\r\n    setup(frm) {\r\n        console.log(\"Promotion form setup triggered\", frm);\r\n\r\n        // Restrict UOM in item_table rows to only the item's defined UOMs\r\n        frm.set_query(\"uom\", \"item_table\", function (doc, cdt, cdn) {\r\n            const row = locals[cdt][cdn];\r\n            console.log(\"Set query for UOM called for row:\", row);\r\n\r\n            if (!row?.item_code) {\r\n                console.log(\"No item_code in row, returning empty query\");\r\n                return {};\r\n            }\r\n\r\n            console.log(\"Applying filter for item_code:\", row.item_code);\r\n            return {\r\n                query: \"erpnext.controllers.queries.get_item_uom_query\",\r\n                filters: { item_code: row.item_code },\r\n            };\r\n        });\r\n\r\n        console.log(\"Setup complete for promotion form\");\r\n    },\r\n});\r\n\r\nfrappe.ui.form.on(\"Item child table\", {\r\n    item_code(frm, cdt, cdn) {\r\n        const row = locals[cdt][cdn];\r\n        console.log(\"item_code change detected in child table row:\", row);\r\n\r\n        if (!row) {\r\n            console.log(\"Row not found, aborting\");\r\n            return;\r\n        }\r\n\r\n        console.log(`Clearing UOM for row with item_code ${row.item_code}`);\r\n        frappe.model.set_value(cdt, cdn, \"uom\", \"\");\r\n\r\n        console.log(\"UOM cleared for row:\", locals[cdt][cdn]);\r\n    },\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "promotion",
  "enabled": 0,
  "modified": "2025-08-21 10:33:57.535050",
  "module": "Gpos",
  "name": "priceadding in promotion",
  "script": "frappe.ui.form.on('Item child table', {\r\n    item_code: function(frm, cdt, cdn) {\r\n        frappe.msgprint(\"üÜï Item Code field triggered\");\r\n\r\n        let row = locals[cdt][cdn];\r\n        frappe.msgprint(\"üìå Selected Item Code: \" + row.item_code);\r\n\r\n        if (row.item_code) {\r\n            if (frm.doc.custom_price_list) {\r\n                frappe.msgprint(\"‚úÖ Price List exists: \" + frm.doc.custom_price_list);\r\n\r\n                frappe.call({\r\n                    method: \"frappe.client.get_list\",\r\n                    args: {\r\n                        doctype: \"Item Price\",\r\n                        filters: {\r\n                            item_code: row.item_code,\r\n                            price_list: frm.doc.custom_price_list\r\n                        },\r\n                        fields: [\"price_list_rate\"],\r\n                        limit_page_length: 1\r\n                    },\r\n                    callback: function(res) {\r\n                        frappe.msgprint(\"üì° API Call Returned for: \" + row.item_code);\r\n\r\n                        if (res.message && res.message.length > 0) {\r\n                            let price = res.message[0].price_list_rate;\r\n                            frappe.msgprint(\"‚úÖ Found Price: \" + price);\r\n                            frappe.model.set_value(cdt, cdn, \"sale_price\", price);\r\n\r\n                            // also trigger discount calculation when sale price is fetched\r\n                            calculate_discount(row, cdt, cdn);\r\n                        } else {\r\n                            frappe.msgprint(\"‚ùå No Price Found for \" + row.item_code + \" in Price List \" + frm.doc.custom_price_list);\r\n                            frappe.model.set_value(cdt, cdn, \"sale_price\", 0);\r\n                        }\r\n                    }\r\n                });\r\n            } else {\r\n                frappe.msgprint(\"‚ö†Ô∏è No Price List selected while choosing Item Code\");\r\n            }\r\n        } else {\r\n            frappe.msgprint(\"‚ö†Ô∏è Item Code is empty\");\r\n        }\r\n    },\r\n\r\n    discount_type: function(frm, cdt, cdn) {\r\n        let row = locals[cdt][cdn];\r\n        calculate_discount(row, cdt, cdn);\r\n    },\r\n\r\n    discount_percentage: function(frm, cdt, cdn) {\r\n        let row = locals[cdt][cdn];\r\n        calculate_discount(row, cdt, cdn);\r\n    },\r\n\r\n    discount_amount: function(frm, cdt, cdn) {\r\n        let row = locals[cdt][cdn];\r\n        calculate_discount(row, cdt, cdn);\r\n    }\r\n});\r\n\r\n\r\n// üîΩ Helper Function\r\nfunction calculate_discount(row, cdt, cdn) {\r\n    let sale_price = flt(row.sale_price) || 0;\r\n    let price_after_discount = sale_price;\r\n\r\n    if (row.discount_type === \"Discount Percentage\") {\r\n        let discount_percentage = flt(row.discount_percentage) || 0;\r\n        price_after_discount = sale_price - (sale_price * discount_percentage / 100);\r\n\r\n    } else if (row.discount_type === \"Discount Amount\" || row.discount_type === \"Rate\") {\r\n        let discount_amount = flt(row.discount__amount) || 0;\r\n        price_after_discount = sale_price - discount_amount;\r\n    }\r\n\r\n    frappe.model.set_value(cdt, cdn, \"price_after_discount\", price_after_discount);\r\n}\r\n",
  "view": "Form"
 }
]